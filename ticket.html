<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MMU Campus Events</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="events.css"> 
</head>
<body>

    <div id="navbar-container"></div>

    <section class="ticket-container">
        
        <div class="ticket-card" id="ticket-card">
            <div class="ticket-header">
                MMU EVENT TICKET
            </div>
            
            <div class="ticket-body">
                <h3 class="ticket-title" id="t-event">Loading...</h3>
                <p class="ticket-info"><strong>Date:</strong> <span id="t-date">--</span></p>
                <p class="ticket-info"><strong>Attendee:</strong> <span id="t-name">--</span></p>
                <p class="ticket-info"><strong>Ref ID:</strong> <span id="t-id" style="font-family: monospace; color: #e74c3c;">--</span></p>

                <div class="qr-code-box">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=MMU-Event-Verified" alt="Ticket QR">
                </div>

                <p style="font-size: 0.85rem; color: #27ae60; font-weight: bold;">
                    ‚úÖ Payment Verified
                </p>
            </div>

            <div class="ticket-footer">
                Please present this e-ticket at the entrance.<br>
                Admit One.
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="window.print()" class="cta-button" style="background-color: #34495e; cursor: pointer; border:none; color:white;">
                üñ®Ô∏è Print Ticket
            </button>
            <a href="bookings.html" class="cta-button" style="background-color: #95a5a6; font-size: 1rem;">
                &larr; Back
            </a>
        </div>

    </section>

    <div id="footer-container"></div>

    <script src="layout.js"></script>
    <script src="data.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userJson = localStorage.getItem('currentUser');
            if (!userJson) {
                alert("Please login to view your ticket.");
                window.location.href = "login.html";
                return;
            }
            const user = JSON.parse(userJson);
            const params = new URLSearchParams(window.location.search);
            const targetId = params.get('bookingId');

            if (!targetId) {
                alert("No ticket specified.");
                window.location.href = "bookings.html";
                return;
            }

            // Find booking record
            const storageKey = `bookings_${user.id}`;
            const myBookings = JSON.parse(localStorage.getItem(storageKey)) || [];
            const booking = myBookings.find(b => b.id === targetId);

            if (booking && booking.status.includes("Confirmed")) {
                document.getElementById('t-event').innerText = booking.title;
                document.getElementById('t-date').innerText = booking.date;
                document.getElementById('t-name').innerText = user.name;
                document.getElementById('t-id').innerText = "#" + booking.id.toUpperCase() + "-" + Math.floor(1000 + Math.random() * 9000); 
            } else {
                // Cannot find or did not make payment
                document.querySelector('.ticket-container').innerHTML = `
                    <div style="text-align:center; padding: 50px;">
                        <h2 style="color:#c0392b;">Ticket Unavailable</h2>
                        <p>Payment not completed or booking not found.</p>
                        <a href="bookings.html" style="color:#3498db;">Go Back</a>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>